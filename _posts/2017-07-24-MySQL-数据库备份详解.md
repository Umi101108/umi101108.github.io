---
layout: post
title:  "MySQL 数据库备份详解"
date:   2017-07-24
categories: MySQL
tags: MySQL 备份
excerpt: MySQL备份说明及脚本
---

* content
{:toc}




## 数据库备份

* 对于任何数据库来说，备份都是非常重要的

* 数据库复制不能取代备份的作用（主从复制时间很短，可能数据已同步）

* 逻辑备份和物理备份

  * 逻辑备份的结果为SQL语句，适合于所有存储引擎

  * 物理备份是对数据库目录的拷贝，对于内存表只备份结构

    工具：XtraBackup

* 全量备份和增量备份

  * 全量备份是对整个数据库的一个完整备份
  * 增量备份是在上次全量或增量备份基础上，对于更改数据进行的备份
    * mysqldump不支持增量备份



### 使用mysqldump进行备份

* 常用语法

  ```shell
  mysqldump [OPTIONS] database [tables]
  mysqldump [OPTIONS] --databases [OPTION] DB1[DB2...]
  mysqldump [OPTIONS] --all-databases [OPTIONS]
  ```

* 常用参数

  * -u, --user=name

  * -p, --password[=name]

    所需权限：SELECT, RELOAD, LOCK TABLES, REPLICATION CLIENT, SHOW VIEW, PROCESS, file

  * --single-transaction 事务型存储引擎

  * -l, --lock-tables 非事务性存储引擎 ，一般用于MyISAM；与上一个参数互斥，不能同时使用

  * -x, --lock-all-tables 会使整个数据库不可写

  * --master-data=[1/2] 

  * -R, --routines 指定存储过程

  * --triggers 指定触发器

  * -E, --events 指定调度事件

  * --hex-blob 将blob、bit、binary备份为16进制的文件，否则会出现文本格式下数据不可见的问题

  * --tab=path 在指定路径下保存文件，一个存储表结构，一个存储数据

  * -w, --where= '过滤条件'

    Where只支持单表数据条件导出



### 备份脚本

```shell
#! /bin/bash
#########################Basic parameters####################
DAY=`date + %Y%m%d`
Environment=$(/sbin/ifconfig | grep "inet addr" | head -l |grep -v "127.0.0.1" | awk '{print $2;}' | awk -F':' '{print $2;}')
USER="backup"
PASSWD="123456"
HostPort="3306"
MYSQLBASE="/home/mysql/"
DATADIR="/data/db_backup/${DAY}"
MYSQL=`/usr/bin/which mysql`
MYSQLDUMP=`/usr/bin/which mysqldump`
mkdir -p ${DATADIR}

Dump(){
  ${MYSQLDUMP} --master-data=2 --single-transaction --routines --triggers --events -u${USER} -p${PASSWD} -P${HostPort} ${database} > ${DATADIR}/${Environment}-${database}.sql
  cd ${DATADIR}
  gzip ${Environment}-${database}.sql
}

for db in `echo "SELECT schema_name FROM information_schema.schemata where schema_name not in ('information_schema', 'sys', 'performance_schema')" | ${MYSQL} -u ${USER} -p${PASSWD} --skip-column-names
do
	database=${db}
	Dump
done
```



### 如何恢复mysqldump备份的数据库

```shell
mysql -u -p dbname < backup.sql
mysql> source /tmp/backup.sql
```

单线程，对于大的备份集可能要消耗大量时间



### 如何进行指定时间点的恢复

* 进行某一时间点的数据恢复

  * 恢复到误操作的时间

* 先决条件

  * 具有指定时间前的一个全备
  * 具有自上次全备后到指定时间点的所有二进制日志

* 恢复步骤

  ```shell
  mysqlbinlog --start-position=84882 --stop-position=169348 --database=mc_ordered mysql-bin.000011 > mc_order_diff.sql
  ```

  ​